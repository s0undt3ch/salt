@Library('salt@master-1.3') _

// Define the maximum time, in hours, that a test run should run for
def testrun_timeout = 6
// Now define a global pipeline timeout. This is the test run timeout with one(1) additional
// hour to allow for artifacts to be downloaded, if possible.
def global_timeout = testrun_timeout + 1;

def distro_name = 'macosx'
def distro_version = 'highsierra'
def python_version = 'py2'
def nox_env_name = 'pytest-zeromq'
def golden_images_branch = 'master'
def nox_passthrough_opts = '--log-cli-level=warning --ignore=tests/utils'
def concurrent_builds = 1
def jenkins_slave_label = 'kitchen-slave-mac'
def kitchen_driver_file = '/var/jenkins/workspace/driver.yml'
def kitchen_verifier_file = '/var/jenkins/workspace/nox-verifier.yml'
def kitchen_platforms_file = '/var/jenkins/workspace/pre-golden-nox-platforms.yml'

properties([
    buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '30')),
    parameters([
        booleanParam(defaultValue: true, description: 'Run full test suite', name: 'runFull')
    ])
])

// Only set milestones on PR builds
if (env.CHANGE_ID) {
    // Be sure to cancel any previously running builds
    def buildNumber = env.BUILD_NUMBER as int
    if (buildNumber > concurrent_builds) {
        // This will cancel the previous build which also defined a matching milestone
        milestone(buildNumber - concurrent_builds)
    }
    // Define a milestone for this build so that, if another build starts, this one will be aborted
    milestone(buildNumber)
}

runTests(
    env: env,
    distro_name: distro_name,
    distro_version: distro_version,
    python_version: python_version,
    golden_images_branch: golden_images_branch,
    nox_env_name: nox_env_name,
    nox_passthrough_opts: nox_passthrough_opts,
    testrun_timeout: testrun_timeout,
    run_full: params.runFull,
    jenkins_slave_label: jenkins_slave_label,
    kitchen_driver_file: kitchen_driver_file,
    kitchen_verifier_file: kitchen_verifier_file,
    kitchen_platforms_file: kitchen_platforms_file)

// vim: ft=groovy
